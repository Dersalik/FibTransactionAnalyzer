@using System.Globalization
@model TransactionAnalyzer.Models.TransactionAnalysisResult
@using Transaction
@{
    ViewData["Title"] = "Transaction Analysis Results";
}
<link rel="stylesheet" href="~/css/analysis-results.css" />

<!-- This view serves as the main dashboard displaying comprehensive transaction analysis.
     It's organized into sections for each currency, with charts and statistics for each analysis type. -->

<div class="container-fluid py-4">
    <!-- Header Section with Overall Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-4 fw-bold text-primary">Analysis Results</h1>
                    <p class="text-muted mb-0">Generated on @Model.AnalysisDate.ToString("MMMM dd, yyyy 'at' HH:mm") UTC</p>
                    @if (Model.DateFrom.HasValue || Model.DateTo.HasValue)
                    {
                        <p class="text-muted small mb-0 mt-1">
                            <i class="fas fa-calendar me-1"></i>
                            <strong>Date Range:</strong>
                            @if (Model.DateFrom.HasValue && Model.DateTo.HasValue)
                            {
                                <span>@Model.DateFrom.Value.ToString("MMM dd, yyyy") - @Model.DateTo.Value.ToString("MMM dd, yyyy")</span>
                            }
                            else if (Model.DateFrom.HasValue)
                            {
                                <span>From @Model.DateFrom.Value.ToString("MMM dd, yyyy")</span>
                            }
                            else if (Model.DateTo.HasValue)
                            {
                                <span>Until @Model.DateTo.Value.ToString("MMM dd, yyyy")</span>
                            }
                        </p>
                    }
                </div>
                <a asp-controller="Analysis" asp-action="Index" class="btn btn-outline-primary">
                    <i class="fas fa-upload me-2"></i>Analyze New File
                </a>
            </div>

            <!-- Overall Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-file-alt text-primary fs-1 mb-2"></i>
                            <h4 class="fw-bold">@Model.TotalTransactionCount</h4>
                            <p class="text-muted mb-0">Total Transactions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-filter text-success fs-1 mb-2"></i>
                            <h4 class="fw-bold">@Model.FilteredTransactionCount</h4>
                            <p class="text-muted mb-0">Analyzed Transactions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-coins text-warning fs-1 mb-2"></i>
                            <h4 class="fw-bold">@Model.CurrencyAnalyses.Count</h4>
                            <p class="text-muted mb-0">Currencies</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-ban text-danger fs-1 mb-2"></i>
                            <h4 class="fw-bold">@(Model.TotalTransactionCount - Model.FilteredTransactionCount)</h4>
                            <p class="text-muted mb-0">Filtered Out</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Currency-specific Analysis Sections -->
    <!-- This loop creates a complete analysis dashboard for each currency found in the data -->
    @foreach (var currencyAnalysis in Model.CurrencyAnalyses)
    {
        var currency = currencyAnalysis.Key;
        var analysis = currencyAnalysis.Value;
        var currencySymbol = currency.ToString();
        var currencyCulture = new CultureInfo(currency.GetCultureCode());

        <div class="currency-section mb-5" id="currency_@currency">
            <div class="row mb-4">
                <div class="col-12">
                    <h2 class="fw-bold text-primary mb-3">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        @currency Analysis
                    </h2>
                </div>
            </div>

            <!-- Currency Navigation Bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body py-2">
                            <nav class="currency-nav">
                                <ul class="nav nav-pills justify-content-center flex-wrap">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#dashboard_@currency" data-section="dashboard" data-currency="@currency">
                                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#transaction-type-analysis_@currency" data-section="transaction-type-analysis" data-currency="@currency">
                                            <i class="fas fa-chart-pie me-1"></i>Transaction Types
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#counterparties-sent-received_@currency" data-section="counterparties-sent-received" data-currency="@currency">
                                            <i class="fas fa-exchange-alt me-1"></i>Sent vs Received
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#top-counterparties-summary_@currency" data-section="top-counterparties-summary" data-currency="@currency">
                                            <i class="fas fa-users me-1"></i>Top Counterparties
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#largest-transactions-by-type_@currency" data-section="largest-transactions-by-type" data-currency="@currency">
                                            <i class="fas fa-star me-1"></i>Largest Transactions
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#counterparties-by-transaction-type_@currency" data-section="counterparties-by-transaction-type" data-currency="@currency">
                                            <i class="fas fa-network-wired me-1"></i>By Transaction Type
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#income-statistics_@currency" data-section="income-statistics" data-currency="@currency">
                                            <i class="fas fa-chart-line me-1"></i>Income Statistics
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section - REDESIGNED -->
            <div id="dashboard_@currency" class="currency-content-section">
                <!-- Hero Financial Summary -->
                <div class="dashboard-hero mb-5">
                    <div class="card border-0 shadow-lg overflow-hidden">
                        <div class="card-body p-0">
                            <div class="row g-0">
                                <!-- Net Balance Hero -->
                                <div class="col-lg-5 hero-net-section d-flex align-items-center justify-content-center p-5 @(analysis.NetAmount >= 0 ? "bg-success-gradient" : "bg-danger-gradient")">
                                    <div class="text-center text-white">
                                        <div class="hero-icon mb-3">
                                            <i class="fas @(analysis.NetAmount >= 0 ? "fa-trending-up" : "fa-trending-down") fa-3x opacity-75"></i>
                                        </div>
                                        <span class="hero-label text-uppercase small fw-semibold opacity-75 d-block mb-2">Net Balance</span>
                                        <h2 class="hero-value display-4 fw-bold mb-2">
                                            @analysis.NetAmount.ToString("C", currencyCulture)
                                        </h2>
                                        <p class="hero-subtitle mb-0 opacity-75">
                                            @(analysis.NetAmount >= 0 ? "You're in the positive!" : "Expenses exceeded income")
                                        </p>
                                    </div>
                                </div>
                                <!-- Stats Grid -->
                                <div class="col-lg-7 p-4">
                                    <div class="row g-4 h-100">
                                        <div class="col-6">
                                            <div class="mini-stat-card h-100 rounded-4 p-4 border border-success border-opacity-25 bg-success bg-opacity-5">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="stat-icon-wrapper rounded-circle bg-success bg-opacity-10 p-2 me-3">
                                                        <i class="fas fa-arrow-down text-success"></i>
                                                    </div>
                                                    <span class="text-muted small fw-semibold text-uppercase">Total Inflow</span>
                                                </div>
                                                <div class="mini-stat-value h4 fw-bold text-success mb-0">@analysis.TotalInflow.ToString("C", currencyCulture)</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mini-stat-card h-100 rounded-4 p-4 border border-danger border-opacity-25 bg-danger bg-opacity-5">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="stat-icon-wrapper rounded-circle bg-danger bg-opacity-10 p-2 me-3">
                                                        <i class="fas fa-arrow-up text-danger"></i>
                                                    </div>
                                                    <span class="text-muted small fw-semibold text-uppercase">Total Outflow</span>
                                                </div>
                                                <div class="mini-stat-value h4 fw-bold text-danger mb-0">@analysis.TotalOutflow.ToString("C", currencyCulture)</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mini-stat-card h-100 rounded-4 p-4 border border-warning border-opacity-25 bg-warning bg-opacity-5">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="stat-icon-wrapper rounded-circle bg-warning bg-opacity-10 p-2 me-3">
                                                        <i class="fas fa-receipt text-warning"></i>
                                                    </div>
                                                    <span class="text-muted small fw-semibold text-uppercase">Total Fees</span>
                                                </div>
                                                <div class="mini-stat-value h4 fw-bold text-warning mb-0">@analysis.TotalFees.ToString("C", currencyCulture)</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mini-stat-card h-100 rounded-4 p-4 border border-info border-opacity-25 bg-info bg-opacity-5">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="stat-icon-wrapper rounded-circle bg-info bg-opacity-10 p-2 me-3">
                                                        <i class="fas fa-exchange-alt text-info"></i>
                                                    </div>
                                                    <span class="text-muted small fw-semibold text-uppercase">Transactions</span>
                                                </div>
                                                <div class="mini-stat-value h4 fw-bold text-info mb-0">@analysis.TransactionCount</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Balance Tracking Chart -->
                <div class="dashboard-chart-section mb-5">
                    <div class="card chart-card-full border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 py-4">
                            <div class="d-flex align-items-center">
                                <div class="chart-icon-wrapper bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="fas fa-chart-area text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-1">Account Balance Tracking</h5>
                                    <p class="text-muted small mb-0">See how your balance has changed over time</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0">
                            <div class="chart-container-full">
                                <canvas id="balanceChart_@currency"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Cash Flow Analysis Chart -->
                <div class="dashboard-chart-section mb-5">
                    <div class="card chart-card-full border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 py-4">
                            <div class="d-flex align-items-center">
                                <div class="chart-icon-wrapper bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="fas fa-chart-bar text-success fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-1">Monthly Cash Flow</h5>
                                    <p class="text-muted small mb-0">Compare your income and expenses month by month</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0">
                            <div class="chart-container-full">
                                <canvas id="cashFlowChart_@currency"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Types Analysis -->
                <div class="dashboard-chart-section mb-5">
                    <div class="card chart-card-full border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 py-4">
                            <div class="d-flex align-items-center">
                                <div class="chart-icon-wrapper bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="fas fa-chart-pie text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-1">Transaction Types Distribution</h5>
                                    <p class="text-muted small mb-0">Breakdown of your transactions by category</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0">
                            <div class="chart-container-doughnut">
                                <canvas id="transactionTypesChart_@currency" class="transaction-types-canvas"></canvas>
                            </div>
                            <!-- Custom legend will be inserted here by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Yearly Analysis Chart -->
                <div class="dashboard-chart-section mb-4">
                    <div class="card chart-card-full border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 py-4">
                            <div class="d-flex align-items-center">
                                <div class="chart-icon-wrapper bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                    <i class="fas fa-calendar-alt text-info fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-1">Yearly Analysis</h5>
                                    <p class="text-muted small mb-0">Your net income performance by year</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0">
                            <div class="chart-container-full">
                                <canvas id="yearlyChart_@currency"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction Type Analysis Section -->
            <div id="transaction-type-analysis_@currency" class="currency-content-section" style="display: none;">
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card table-card border-0 shadow-sm">
                            <div class="card-header bg-white border-0">
                                <h5 class="fw-bold mb-0">Transaction Type Analysis</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Type</th>
                                                <th>Count</th>
                                                <th>Average</th>
                                                <th>Largest</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var typeAnalysis in analysis.TransactionTypeAnalyses.OrderByDescending(t => t.TotalAmount))
                                            {
                                                <tr>
                                                    <td>@typeAnalysis.TransactionType.Replace("_", " ")</td>
                                                    <td><span class="badge bg-primary">@typeAnalysis.Count</span></td>
                                                    <td>@typeAnalysis.AverageAmount.ToString("C", currencyCulture)</td>
                                                    <td>@typeAnalysis.LargestAmount.ToString("C", currencyCulture)</td>
                                                    <td>@typeAnalysis.TotalAmount.ToString("C", currencyCulture)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Counterparties - Sent vs Received Section -->
            <div id="counterparties-sent-received_@currency" class="currency-content-section" style="display: none;">
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card table-card border-0 shadow-sm">
                            <div class="card-header bg-white border-0">
                                <h5 class="fw-bold mb-0">
                                    <i class="fas fa-exchange-alt text-info me-2"></i>
                                    Counterparties - Sent vs Received
                                </h5>
                                <p class="text-muted small mb-0">Money flow analysis with counterparties (click headers to sort)</p>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="counterpartiesTable_@currency">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="sortable" data-sort="counterparty" style="cursor: pointer;">
                                                    Counterparty <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="text-danger sortable" data-sort="sent" style="cursor: pointer;">
                                                    Sent <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="text-success sortable" data-sort="received" style="cursor: pointer;">
                                                    Received <i class="fas fa-sort ms-1"></i>
                                                </th>
                                                <th class="sortable active-sort" data-sort="net" style="cursor: pointer;">
                                                    Net Balance <i class="fas fa-sort-down ms-1"></i>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="counterpartiesTableBody_@currency">
                                            @{
                                                // Sort by net amount descending initially (highest net balance first)
                                                var sortedCounterparties = analysis.TopCounterparties.OrderByDescending(c => c.NetAmount).ToList();
                                                var counterpartiesToShow = sortedCounterparties.Take(20).ToList();
                                                var hasMoreCounterparties = sortedCounterparties.Count() > 20;
                                            }
                                            @foreach (var counterparty in counterpartiesToShow)
                                            {
                                                <tr class="counterparty-row-visible">
                                                    <td data-value="@counterparty.Counterparty.ToLower()">
                                                        <strong>@counterparty.Counterparty</strong>
                                                        <br>
                                                        <small class="text-muted">@counterparty.TransactionCount transactions</small>
                                                    </td>
                                                    <td class="text-danger" data-value="@counterparty.AmountSent">
                                                        <strong>@counterparty.AmountSent.ToString("C", currencyCulture)</strong>
                                                    </td>
                                                    <td class="text-success" data-value="@counterparty.AmountReceived">
                                                        <strong>@counterparty.AmountReceived.ToString("C", currencyCulture)</strong>
                                                    </td>
                                                    <td data-value="@counterparty.NetAmount">
                                                        <strong class="@(counterparty.NetAmount >= 0 ? "text-success" : "text-danger")">
                                                            @counterparty.NetAmount.ToString("C", currencyCulture)
                                                        </strong>
                                                        <br>
                                                        <small class="text-muted">
                                                            @(counterparty.NetAmount >= 0 ? "You received more" : "You sent more")
                                                        </small>
                                                    </td>
                                                </tr>
                                            }
                                            @if (hasMoreCounterparties)
                                            {
                                                @foreach (var counterparty in sortedCounterparties.Skip(20))
                                                {
                                                    <tr class="counterparty-row-hidden" style="display: none;">
                                                        <td data-value="@counterparty.Counterparty.ToLower()">
                                                            <strong>@counterparty.Counterparty</strong>
                                                            <br>
                                                            <small class="text-muted">@counterparty.TransactionCount transactions</small>
                                                        </td>
                                                        <td class="text-danger" data-value="@counterparty.AmountSent">
                                                            <strong>@counterparty.AmountSent.ToString("C", currencyCulture)</strong>
                                                        </td>
                                                        <td class="text-success" data-value="@counterparty.AmountReceived">
                                                            <strong>@counterparty.AmountReceived.ToString("C", currencyCulture)</strong>
                                                        </td>
                                                        <td data-value="@counterparty.NetAmount">
                                                            <strong class="@(counterparty.NetAmount >= 0 ? "text-success" : "text-danger")">
                                                                @counterparty.NetAmount.ToString("C", currencyCulture)
                                                            </strong>
                                                            <br>
                                                            <small class="text-muted">
                                                                @(counterparty.NetAmount >= 0 ? "You received more" : "You sent more")
                                                            </small>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            @if (hasMoreCounterparties)
                            {
                                <div class="card-footer bg-light border-0 text-center">
                                    <button class="btn btn-outline-primary btn-sm" id="toggleCounterparties_@currency" onclick="toggleCounterpartiesView('@currency')">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        Show All (@sortedCounterparties.Count() total)
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Counterparties Summary Section -->
            <div id="top-counterparties-summary_@currency" class="currency-content-section" style="display: none;">
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card table-card border-0 shadow-sm">
                            <div class="card-header bg-white border-0">
                                <h5 class="fw-bold mb-0">Top Counterparties Summary</h5>
                                <p class="text-muted small mb-0">Overall transaction summary with all counterparties</p>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Counterparty</th>
                                                <th>Total Transactions</th>
                                                <th>Total Amount</th>
                                                <th>Average per Transaction</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var counterparty in analysis.TopCounterparties.OrderByDescending(c => c.TotalAmount).Take(13))
                                            {
                                                <tr>
                                                    <td>@counterparty.Counterparty</td>
                                                    <td><span class="badge bg-info">@counterparty.TransactionCount</span></td>
                                                    <td>@counterparty.TotalAmount.ToString("C", currencyCulture)</td>
                                                    <td>@counterparty.AverageAmount.ToString("C", currencyCulture)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Largest Transactions By Type Section -->
            @if (analysis.LargestTransactionsByType.Any())
            {
                <div id="largest-transactions-by-type_@currency" class="currency-content-section" style="display: none;">
                    <div class="row g-4 mb-4">
                        <div class="col-12">
                            <div class="card table-card border-0 shadow-sm">
                                <div class="card-header bg-white border-0">
                                    <h5 class="fw-bold mb-0">
                                        <i class="fas fa-star text-warning me-2"></i>
                                        Largest Transactions By Type
                                    </h5>
                                    <p class="text-muted small mb-0">The biggest transaction in each category</p>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Transaction Type</th>
                                                    <th>Amount</th>
                                                    <th>Counterparty</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                    <th>Note</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var largestType in analysis.LargestTransactionsByType)
                                                {
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-secondary">@largestType.TransactionType.Replace("_", " ")</span>
                                                        </td>
                                                        <td>
                                                            <strong class="@(largestType.LargestAmount >= 0 ? "text-success" : "text-danger")">
                                                                @largestType.LargestAmount.ToString("C", currencyCulture)
                                                            </strong>
                                                        </td>
                                                        @if (largestType.LargestTransaction != null)
                                                        {
                                                            <td>@(string.IsNullOrEmpty(largestType.LargestTransaction.Counterparty) ? "-" : largestType.LargestTransaction.Counterparty)</td>
                                                            <td>@largestType.LargestTransaction.Date.ToString("MMM dd, yyyy")</td>
                                                            <td>
                                                                <span class="badge @(largestType.LargestTransaction.Status == "COMPLETED" ? "bg-success" : "bg-warning")">
                                                                    @largestType.LargestTransaction.Status
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <small class="text-muted">
                                                                    @(string.IsNullOrEmpty(largestType.LargestTransaction.Note) ? "-" :
                                                                                                                        (largestType.LargestTransaction.Note.Length > 30 ?
                                                                                                                        largestType.LargestTransaction.Note.Substring(0, 30) + "..." :
                                                                                                                        largestType.LargestTransaction.Note))
                                                                </small>
                                                            </td>
                                                        }
                                                        else
                                                        {
                                                            <td colspan="4" class="text-muted">Transaction details not available</td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Individual Largest Transactions with Full Details -->
                                @if (analysis.TransactionTypeAnalyses.Any(t => t.LargestTransaction != null))
                                {
                                    <div class="card-body border-top">
                                        <h6 class="fw-bold mb-3">
                                            <i class="fas fa-medal text-gold me-2"></i>
                                            Significant Transaction Details
                                        </h6>
                                        <div class="row g-0">
                                            @foreach (var typeAnalysis in analysis.TransactionTypeAnalyses.Where(t => t.LargestTransaction != null))
                                            {
                                                var transaction = typeAnalysis.LargestTransaction!;
                                                <div class="col-lg-6 p-0">
                                                    <div class="border-end border-bottom p-4">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <div>
                                                                <h6 class="fw-bold mb-1">@typeAnalysis.TransactionType.Replace("_", " ")</h6>
                                                                <span class="badge @(transaction.Status == "COMPLETED" ? "bg-success" : "bg-warning")">
                                                                    @transaction.Status
                                                                </span>
                                                            </div>
                                                            <div class="text-end">
                                                                <div class="h5 fw-bold mb-0 @(transaction.Amount.Amount >= 0 ? "text-success" : "text-danger")">
                                                                    @transaction.Amount.Amount.ToString("C", currencyCulture)
                                                                </div>
                                                                @if (transaction.Fee.Amount > 0)
                                                                {
                                                                    <small class="text-muted">Fee: @transaction.Fee.Amount.ToString("C", currencyCulture)</small>
                                                                }
                                                            </div>
                                                        </div>

                                                        <div class="row g-2 small">
                                                            <div class="col-6">
                                                                <strong>Date:</strong><br>
                                                                <span class="text-muted">@transaction.Date.ToString("MMM dd, yyyy")</span>
                                                            </div>
                                                            <div class="col-6">
                                                                <strong>Time:</strong><br>
                                                                <span class="text-muted">@transaction.Time.ToString(@"hh\:mm")</span>
                                                            </div>
                                                            @if (!string.IsNullOrEmpty(transaction.Counterparty))
                                                            {
                                                                <div class="col-12 mt-2">
                                                                    <strong>Counterparty:</strong><br>
                                                                    <span class="text-muted">@transaction.Counterparty</span>
                                                                </div>
                                                            }
                                                            @if (transaction.TransactionId.HasValue)
                                                            {
                                                                <div class="col-12 mt-2">
                                                                    <strong>Transaction ID:</strong><br>
                                                                    <code class="small">@transaction.TransactionId.Value</code>
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrEmpty(transaction.Note))
                                                            {
                                                                <div class="col-12 mt-2">
                                                                    <strong>Note:</strong><br>
                                                                    <span class="text-muted">@transaction.Note</span>
                                                                </div>
                                                            }
                                                            <div class="col-12 mt-2">
                                                                <strong>Balance After:</strong><br>
                                                                <span class="text-info">@transaction.BalanceAfter.Amount.ToString("C", currencyCulture)</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Counterparties By Transaction Type Section -->
            @if (analysis.CounterpartiesByTransactionType.Any())
            {
                <div id="counterparties-by-transaction-type_@currency" class="currency-content-section" style="display: none;">
                    <div class="row g-4 mb-4">
                        <div class="col-12">
                            <div class="card table-card border-0 shadow-sm">
                                <div class="card-header bg-white border-0">
                                    <h5 class="fw-bold mb-0">
                                        <i class="fas fa-network-wired text-info me-2"></i>
                                        Counterparties by Transaction Type
                                    </h5>
                                    <p class="text-muted small mb-0">Transaction patterns between you and counterparties</p>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        @foreach (var typeGroup in analysis.CounterpartiesByTransactionType)
                                        {
                                            <div class="col-lg-6 mb-4">
                                                <div class="border rounded p-3 bg-light">
                                                    <h6 class="fw-bold text-primary mb-3">
                                                        <i class="fas fa-tag me-1"></i>
                                                        @typeGroup.Key.Replace("_", " ")
                                                    </h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-borderless mb-0">
                                                            <thead>
                                                                <tr class="border-bottom">
                                                                    <th class="small">Counterparty</th>
                                                                    <th class="small text-center">Count</th>
                                                                    <th class="small text-end">Total</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var counterparty in typeGroup.Value)
                                                                {
                                                                    <tr>
                                                                        <td class="small">
                                                                            @(counterparty.Counterparty)
                                                                        </td>
                                                                        <td class="small text-center">
                                                                            <span class="badge bg-info badge-sm">@counterparty.Count</span>
                                                                        </td>
                                                                        <td class="small text-end">
                                                                            @counterparty.TotalAmount.ToString("C0", currencyCulture)
                                                                        </td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Income Statistics Section -->
            @if (analysis.MonthlyAnalyses.Any())
            {
                <div id="income-statistics_@currency" class="currency-content-section" style="display: none;">
                    <div class="row g-4 mb-5">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white border-0">
                                    <h5 class="fw-bold mb-0">Income Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <h6 class="text-muted">Average Monthly</h6>
                                            <h4 class="fw-bold text-primary">@analysis.AverageMonthlyIncome.ToString("C", currencyCulture)</h4>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-muted">Highest Month</h6>
                                            <h4 class="fw-bold text-success">@analysis.MaxMonthlyIncome.ToString("C", currencyCulture)</h4>
                                            @if (analysis.BestIncomeMonth != null)
                                            {
                                                <small class="text-muted">@analysis.BestIncomeMonth.MonthName</small>
                                            }
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-muted">Lowest Month</h6>
                                            <h4 class="fw-bold text-warning">@analysis.MinMonthlyIncome.ToString("C", currencyCulture)</h4>
                                            @if (analysis.WorstIncomeMonth != null)
                                            {
                                                <small class="text-muted">@analysis.WorstIncomeMonth.MonthName</small>
                                            }
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-muted">Total Months</h6>
                                            <h4 class="fw-bold text-info">@analysis.MonthlyAnalyses.Count</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Chart.js Library and Custom Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="~/js/analysis-results.js"></script>

<script>
    // Initialize charts for each currency with their specific data
    @foreach (var currencyAnalysis in Model.CurrencyAnalyses)
    {
            var currency = currencyAnalysis.Key;
            var analysis = currencyAnalysis.Value;

            <text>
            // Create charts for @currency
            window.createCurrencyCharts('@currency', {
                balanceHistory: {
                    labels: [@Html.Raw(string.Join(",", analysis.BalanceHistory.Select(b => $"'{b.FormattedDate}'")))],
                    data: [@Html.Raw(string.Join(",", analysis.BalanceHistory.Select(b => b.Balance.ToString("F2"))))]
                },
                monthlyAnalyses: {
                    labels: [@Html.Raw(string.Join(",", analysis.MonthlyAnalyses.Select(m => $"'{m.MonthName}'")))],
                    income: [@Html.Raw(string.Join(",", analysis.MonthlyAnalyses.Select(m => m.Income.ToString("F2"))))],
                    expenses: [@Html.Raw(string.Join(",", analysis.MonthlyAnalyses.Select(m => m.Expenses.ToString("F2"))))]
                },
                transactionTypes: {
                    labels: [@Html.Raw(string.Join(",", analysis.TransactionTypeAnalyses.Select(t => $"'{t.TransactionType.Replace("_", " ")}'")))],
                    data: [@Html.Raw(string.Join(",", analysis.TransactionTypeAnalyses.Select(t => t.Count.ToString())))]
                },
                yearlyAnalyses: {
                    labels: [@Html.Raw(string.Join(",", analysis.YearlyAnalyses.Select(y => y.Year.ToString())))],
                    data: [@Html.Raw(string.Join(",", analysis.YearlyAnalyses.Select(y => y.NetIncome.ToString("F2"))))]
                }
            });
            </text>
    }
</script>